@model WEB.Models.ListPlaceUrlTrackModels
<div id="map"></div>
<div class="ButtonPanel">
    <div class="btn-group btn-group-justified">
        <a id="CreatePlace" class="btn btn-primary">Создать точку</a>
        <a id="CreateTrack" class="btn btn-primary" data-toggle="modal"
           data-target="#basicModal">Создать маршрут</a>
    </div> 
</div>
<div id="map2"></div>
<script>

    var markers = [];
    var marker;
    var map;
    var latlng;
    var latlngStr;
    var distance;
    var contentString;
    var selectMarker;

    function pinSymbol(color) {
        return {
            path:
                'M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z M -2,-30 a 2,2 0 1,1 4,0 2,2 0 1,1 -4,0',
            fillColor: color,
            fillOpacity: 1,
            strokeColor: '#000',
            strokeWeight: 2,
            scale: 1,
        };
    }

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'),
            {
                zoom: 3,
                center: { lat: 41.85, lng: -87.65 }
            });
        var ctaLayer = new google.maps.KmlLayer({
            //url: 'https://raw.githubusercontent.com/npv256/TripHelper/master/WEB/Content/Baigura.kml',
            //url: 'https://www.gpslib.ru/tracks/download/7092.gpx',
            map: map,
            suppressInfoWindows: true,
            clickable: false
        });

        @foreach (var model1 in Model.PlaceList)
        {
            <text>
                var markerlatLng = new google.maps.LatLng(@(model1.Latitude), @(model1.Longitude));
                 addMarkerWithTimeout(markerlatLng, map, @model1.Id);
            </text>

        }

        google.maps.event.addListener(map,
            'click',
            function(event) {
                if (marker != null)
                    marker.setMap(null);
                marker = new google.maps.Marker({
                    position: event.latLng,
                    map: map,
            });
                $("#Latitude").val(event.latLng.lat());
                $("#Longitude").val(event.latLng.lng());
            });     

        var markerCluster = new MarkerClusterer(map,
            markers,
            { imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m' });


        //function addInfoWindow(marker, id) {

        //    var infoWindow = new google.maps.InfoWindow({
        //        content: ""
        //});

        //    google.maps.event.addListener(marker, 'click', function () {
        //        infoWindow.open(map, marker);
        //    });
        //}

        function addMarkerWithTimeout(location, map, id) {
            // Add the marker at the clicked location, and add the next-available label
            // from the array of alphabetical characters.
            //   setMapOnAll(null

            if (marker != null)
                marker.setMap(null);
            marker = new google.maps.Marker({
                position: location,
                map: map,
                animation: google.maps.Animation.DROP,
                icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                id: id,
            });
            //addInfoWindow(marker, id);

            marker.addListener('click', function() {
                if(selectMarker!=null)
                {
                    selectMarker.setAnimation(null);
                    selectMarker.setIcon('http://maps.google.com/mapfiles/ms/icons/blue-dot.png');
                }
                $('#PlaceDetails').hide(100);
                $('#PlaceDetails').load('@Url.Action("Details", "Place")/' + id);
                $('#PlaceDetails').show(300);
                selectMarker = markers.find(x => x.id === id);
                selectMarker.setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png');
                selectMarker.setAnimation(google.maps.Animation.BOUNCE);
                map.setCenter(location);
                if (marker != null)
                    marker.setMap(null);
            });

            markers.push(marker);
            marker = null;
        }

        $('#CreatePlacePanel').load('@Url.Action("Create", "Place")');
        $('#CreateTrackModel').load('@Url.Action("Create", "Track")');

        function setMapOnAll(map,icon) {
                for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(map);
            }
        }

        $("#CreatePlacePanel").hide();
        $("#CreateTrackModel").hide();
    }
</script>

<script  type="text/javascript">
    var StatePlacePanel = false;
    var StateTrackPanel = false;
    $(document).ready(function() {
        $('#CreatePlace').click(function(e) {
            e.preventDefault();
            if (StatePlacePanel) {
                $("#CreatePlacePanel").hide(300);
                StatePlacePanel = false;
            } else {
                StatePlacePanel = true;
                $("#CreatePlacePanel").show(300);
            }
        });
    });

    $(document).ready(function() {
        $('#CreateTrack').click(function(e) {
            e.preventDefault();
            if (StateTrackPanel) {
                //  $("#CreateTrackPanel").hide();
                StateTrackPanel = false;
            } else {
                StateTrackPanel = true;
                $("#CreateTrackModel").show(300);
            }
        });
    });

</script>

<script>
    $(function() {
        $('#PlaceDetails').hide();
        $('#PlaceDetails').draggable();
	
    });
</script>


<link rel="stylesheet" href="http://ajax.aspnetcdn.com/ajax/jquery.ui/1.10.3/themes/sunny/jquery-ui.css">
<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlr6EQIpiTn35E_RJ-TFvfo1vHKR_ajts&callback=initMap"
        type="text/javascript"></script>
<div id="CreatePlacePanel"></div>
<div id="CreateTrackModel"></div>
<div id="PlaceDetails"></div>
